<?php
?>

<script type="text/javascript">

    window.onload = function() {
        var el = document.getElementById("captureplus_login_license_key");
        if(el) {
            hideFields(true);
            if(el.value=='') {
                var feedback = document.getElementById("captureplus_login_feedback");
                if (feedback) {
                    feedback.innerHTML = 'You are not logged in';
                    updateLoginHeader("Log in to PCA Predict");
                    updateButton("Login");
                    disableLoginFields(false);
                    //notLoggedIn();
                }
            } else {
                var feedback = document.getElementById("captureplus_login_feedback");
                if (feedback) {
                    feedback.innerHTML = 'You are logged in';
                    updateLoginHeader("Your PCA Predict Account");
                    updateButton("Logout");
                    disableLoginFields(true);
                    //loggedIn();
                    getKeySettings();
                }
            }
        }
    }

    function hideFields(disableOnly) {
        var el2 = document.getElementById("row_captureplus_login_license_key");
        if(el2) {
            if (!disableOnly){
                el2.style.visibility = "hidden";
            }
            var el2Val = document.getElementById("captureplus_login_license_key");
            if (el2Val) {
                el2Val.setAttribute('disabled', '');
            }
        }
        var el3 = document.getElementById("row_captureplus_login_mercury_token");
        if(el3) {
            if (!disableOnly){
                el3.style.visibility = "hidden";
            }
            var ele3Val = document.getElementById("captureplus_login_mercury_token");
            if (ele3Val) {
                ele3Val.setAttribute('disabled', '');
            }
        }
    }

    function notLoggedIn() {
        //Try and hide settings if the child is there and the parent is a "section-config" class.
        var me = document.getElementById("captureplus_settings");
        
        if(me && (me.parentElement.className == "section-config" || me.parentElement.className == "section-config active")){
            me.parentElement.style.visibility = "hidden";
        }
    }

    function loggedIn() {
        //Try and hide settings if the child is there and the parent is a "section-config" class.
        var me = document.getElementById("captureplus_settings");
        
        if(me && (me.parentElement.className == "section-config" || me.parentElement.className == "section-config active")){
            me.parentElement.style.visibility = "visible";
        }
    }

    function updateLoginHeader(title) {
        var head = document.getElementById("captureplus_login-head");
        if(head) {
            head.innerHTML = title;
        }
    }

    function updateButton(title) {
        var btn = document.getElementById("postcodeanywherecaptureplus_button");
        if(btn) {
            btn.title = title;
            btn.disabled = false;
            btn.innerHTML = "<span><span><span>" + title + "</span></span></span>";
        }
    }

    function disableLoginFields(disabled) {
        var username = document.getElementById("captureplus_login_account_code");
        if (username) {
            username.disabled = disabled; 
        }

        var password = document.getElementById("captureplus_login_pca_password");
        if (password) {
            password.disabled = disabled;
        }
    }

    // function getCollapsedState(containerId) {
    //     var collapsed = 0;

    //     if ($(containerId + '-state')) {
    //         collapsed = $(containerId + '-state').value == 1 ? 0 : 1;
    //     } else {
    //         collapsed = $(containerId + '-head').collapsed;
    //     }

    //     return collapsed;
    // }

    function getAuth() {
        var txtAccountCode = document.getElementById("captureplus_login_account_code");
        if(txtAccountCode) {
            var txtToken = document.getElementById("captureplus_login_mercury_token");
            if(txtToken) {
                return btoa(txtAccountCode.value + ':' + txtToken.value);
            }
        }
    }

    function getKeySettings() {

        var txtKey = document.getElementById('captureplus_login_license_key');
        if(txtKey) {
            var key = txtKey.value;
            var auth = getAuth();
            var body = {
            "key": key
            };
            fetch('https://app_api.pcapredict.com/api/GetLicenseDetails', {
                method: 'POST',
                body: JSON.stringify(body),
                headers: new Headers({
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + auth
                })
            }).then(function(response){
                //get json
                response.json().then(function(jsonObject){
                    displayKeySettings(jsonObject);
                }, function(){ /*TODO: Deal with error*/ });
            }, function(){ /*TODO: Deal with error*/ })
        }
    }

    function updateKeySettings() {

        var auth = getAuth();

        var body = buildKeyUpdateBody();

        fetch('https://app_api.pcapredict.com/api/SetLicenseDetails', {
            method: 'POST',
            body: JSON.stringify(body),
            headers: new Headers({
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + auth
            })
        }).then(function(response){
            //get json
            response.json().then(function(jsonObject){
                displayKeySettings(jsonObject);
            }, function(){ /*TODO: Deal with error*/ });
        }, function(){ /*TODO: Deal with error*/ })
    }

    function displayKeySettings(keySettings) {

        var el2 = document.getElementById("captureplus_login_license_key");
        if (el2) {
            el2.value = keySettings.licenceKey;
        }

        // list the url list of restrictions.
        var urls = '';
        for (var i = 0; i < keySettings.urlRestrictions.length; i++) {
            urls = urls + keySettings.urlRestrictions[i] + '\n';
        }

        var txtUrlRestrictions = document.getElementById("captureplus_settings_url_restrictions");
        if (txtUrlRestrictions) {
            txtUrlRestrictions.value = urls;
        }
    }

    function buildKeyUpdateBody() {
        
        var txtKey = document.getElementById('captureplus_login_license_key');
        if(txtKey) {
            var key = txtKey.value;
        }

        var txtUrlRestrictions = document.getElementById("captureplus_settings_url_restrictions");
        if (txtUrlRestrictions) {
            var rawUrls = txtUrlRestrictions.value.split('\n');
        }      

        var urls = [];

        for(var i = 0; i < rawUrls.length; i++) {
            if (rawUrls[i].length > 0) {
                urls.push(rawUrls[i]);
            }
        }

        var body = {
            "Key": key,
            "UrlRestrictions": urls
        }

        return body;
    }

    var reload = configForm.submit;

    configForm.submit = function() {
        var el = document.getElementById("captureplus_login_license_key");

        if(el) {
            if(el.value=='') {
                
            } else {
                updateKeySettings();
            }
        }
        var ret = reload.apply(this);
        return ret;
    }

    function formatDate(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0'+minutes : minutes;
        var strTime = hours + ':' + minutes + ' ' + ampm;
        return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear();
    }

</script>